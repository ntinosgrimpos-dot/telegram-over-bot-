import os
import math
from dataclasses import dataclass

from aiogram import Bot, Dispatcher, executor, types

TOKEN = os.getenv("BOT_TOKEN")

@dataclass
class MatchState:
    minute: int = 0
    home: int = 0
    away: int = 0
    lam90: float = 2.6
    tempo: float = 1.0

STATE = {}

def clamp(x, a, b):
    return max(a, min(b, x))

def poisson_p_ge_k(mu, k):
    if k <= 0:
        return 1.0
    s = 0.0
    for i in range(k):
        s += math.exp(-mu) * (mu ** i) / math.factorial(i)
    return clamp(1 - s, 0, 1)

def fair(p):
    return "∞" if p <= 0 else f"{1/p:.2f}"

def mu_rem(st):
    return st.lam90 * ((90 - st.minute) / 90) * st.tempo

def p_window(st, start):
    m = max(st.minute, start)
    mu = st.lam90 * ((90 - m) / 90) * st.tempo
    return clamp(1 - math.exp(-mu), 0, 1)

def render(st):
    mu = mu_rem(st)
    t = st.home + st.away
    p05 = poisson_p_ge_k(mu, 1)
    p15 = poisson_p_ge_k(mu, max(0, 2 - t))
    p25 = poisson_p_ge_k(mu, max(0, 3 - t))
    p75 = p_window(st, 75)

    return (
        f"⏱ {st.minute}' | {st.home}-{st.away}\n"
        f"μ: {mu:.2f}\n\n"
        f"Over 0.5: {p05*100:.1f}% | {fair(p05)}\n"
        f"Over 1.5: {p15*100:.1f}% | {fair(p15)}\n"
        f"Over 2.5: {p25*100:.1f}% | {fair(p25)}\n\n"
        f"Goal 75-FT: {p75*100:.1f}% | {fair(p75)}"
    )

def kb():
    keyboard = types.InlineKeyboardMarkup(row_width=2)
    keyboard.add(
        types.InlineKeyboardButton("Tempo +", callback_data="tp+"),
        types.InlineKeyboardButton("Tempo -", callback_data="tp-"),
    )
    keyboard.add(types.InlineKeyboardButton("+1’", callback_data="m+"))
    return keyboard


bot = Bot(token=TOKEN)
dp = Dispatcher(bot)

@dp.message_handler(commands=["start"])
async def start(m: types.Message):
    await m.answer("Γράψε: /match 62 1-0 2.60")

@dp.message_handler(lambda m: m.text and m.text.startswith("/match"))
async def match(m: types.Message):
    try:
        p = m.text.split()
        st = MatchState(
            minute=int(p[1]),
            home=int(p[2].split("-")[0]),
            away=int(p[2].split("-")[1]),
            lam90=float(p[3]),
        )
        # μικρά clamps για να μη ξεφεύγει
        st.minute = clamp(st.minute, 0, 90)
        st.tempo = clamp(st.tempo, 0.70, 1.60)

        STATE[m.chat.id] = st
        await m.answer(render(st), reply_markup=kb())
    except Exception:
        await m.answer("❌ Σωστό: /match 62 1-0 2.60")

@dp.callback_query_handler(lambda q: q.data in ("tp+", "tp-", "m+"))
async def cb(q: types.CallbackQuery):
    st = STATE.get(q.message.chat.id)
    if not st:
        await q.answer("Γράψε πρώτα /match", show_alert=True)
        return

    if q.data == "tp+":
        st.tempo = clamp(st.tempo + 0.05, 0.70, 1.60)
    elif q.data == "tp-":
        st.tempo = clamp(st.tempo - 0.05, 0.70, 1.60)
    elif q.data == "m+":
        st.minute = clamp(st.minute + 1, 0, 90)

    await q.message.edit_text(render(st), reply_markup=kb())
    await q.answer()

if __name__ == "__main__":
    if not TOKEN:
        raise RuntimeError("Missing BOT_TOKEN")
    executor.start_polling(dp, skip_updates=True)
